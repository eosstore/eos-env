# Exchange Contract

A Docker example is available at: https://github.com/EOSIO/eosjs/tree/dawn3/docker
From this docker directory, the following setup may be used:

```
# Optionally pick a tag, or latest is used by default: https://hub.docker.com/r/eosio/eos/tags/
# echo EOSIO_IMAGE=eosio/eos:20180322 >> .env

docker-compose down # Reset the volumes (resets everything, wallet and blockchain)
docker-compose up -d # Start the server
docker-compose logs -f | egrep -v 'eosio generated block' &

# setup the cli wallet command
alias cleos='docker-compose exec walletd /opt/eosio/bin/cleos -H nodeosd'
```

In any case, a similar setup as followed may be used.  Please make sure you have unlocked wallet and have the test key imported
- We need wallet_api_plugin in your eos node (nodeosd), ensure your config.ini has `eosio::wallet_api_plugin` before starting the eos node
- If you have never create a wallet before, create one first
    ```
    $ cleos wallet create
    ```
  Otherwise, you can just open existing wallet and unlock it
    ```
    $ cleos wallet open && cleos wallet unlock --password <your_wallet_password_here>
    ```
- Importing test key
    ```
    $ cleos wallet import 5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3
    ```

## Making order and checking order book
1. Setup
```
# create accounts
cleos create account eosio currency EOS6MRyAjQq8ud7hVNYcfnVPJqcVpscN5So8BhtHuGYqET5GDW5CV EOS6MRyAjQq8ud7hVNYcfnVPJqcVpscN5So8BhtHuGYqET5GDW5CV
cleos create account eosio exchange EOS6MRyAjQq8ud7hVNYcfnVPJqcVpscN5So8BhtHuGYqET5GDW5CV EOS6MRyAjQq8ud7hVNYcfnVPJqcVpscN5So8BhtHuGYqET5GDW5CV
cleos create account eosio inita EOS6MRyAjQq8ud7hVNYcfnVPJqcVpscN5So8BhtHuGYqET5GDW5CV EOS6MRyAjQq8ud7hVNYcfnVPJqcVpscN5So8BhtHuGYqET5GDW5CV
cleos create account eosio initb EOS6MRyAjQq8ud7hVNYcfnVPJqcVpscN5So8BhtHuGYqET5GDW5CV EOS6MRyAjQq8ud7hVNYcfnVPJqcVpscN5So8BhtHuGYqET5GDW5CV

# publish smart contracts
# If you are using docker, the path to compiled contracts will be `contracts`. Otherwise, it will be `eos/build/contracts`
cleos set contract currency contracts/currency/currency.wast contracts/currency/currency.abi
cleos set contract eosio contracts/eosio.system/eosio.system.wast contracts/eosio.system/eosio.system.abi
cleos set contract exchange contracts/exchange/exchange.wast contracts/exchange/exchange.abi

# setup new tokens
cleos push action eosio issue '{"to":"eosio", "quantity": "1000000000.0000 EOS", "memo": ""}' -p eosio@active
cleos push action currency create '{"issuer":"currency", "maximum_supply": "1000000000.0000 CUR", "can_freeze": 1, "can_recall": 1, "can_whitelist": 1}' -p currency@active
cleos push action currency issue '{"to":"currency", "quantity": "1000000000.0000 CUR", "memo": ""}' -p currency@active
```

2. The story here is `inita` has `eos` and wants to buy `currency`. While `initb` has `currency` and wants to sell it to `inita`.
    - Give `initb` currenty and give `inita` some EOS
        ```
        $ cleos push action currency transfer '{"from":"currency", "to":"initb", "quantity": "1000000.0000 CUR", "memo": ""}' -p currency@active
        $ cleos push action eosio transfer '{"from":"eosio", "to":"inita", "quantity": "1000000.0000 EOS", "memo": ""}' -p eosio@active
        ```

3. Deposit initial balance to `exchange`
    - `inita` deposits some `eos` to the `exchange` 
        ```
        # 4 decimal places are implied in the amount https://github.com/EOSIO/eos/issues/561
        $ cleos transfer inita exchange 10000000000 'deposit'
        ```
    - `initb` deposits some `currency` to the `exchange`
        ```
        $ cleos push action currency transfer '{"from":"initb", "to":"exchange", "quantity": "1000000.0000 CUR", "memo": "deposit"}' -p initb@active
        ```
    - You can check the amount money of both accounts have deposited using `cleos get table`
        ```
        $ cleos get table exchange exchange account
        {
        "rows": [{
            "owner": "inita",
            "eos_balance": 1000000,
            "currency_balance": 0,
            "open_orders": 0
            },{
            "owner": "initb",
            "eos_balance": 0,
            "currency_balance": 1000000,
            "open_orders": 0
            }
        ],
        "more": false
        }
        ```



4. `inita` makes a buy order. He wants to buy `currency` using 100 `eos` with price 5 `currency` per `eos`. 
   - Precision of `price` is 10^15.
   - `number` here is an identifier that should be unique per order-account, it will be used later on to identify this order. It can be any uint64 number that is currently not used to identify any active order that belongs to that account. For convenience, in this case we are using timestamp as the order number.
    ```
    $ cleos push action exchange buy '{"buyer":{ "name": "inita", "number": "1516073924"}, "at_price":"5000000000000000", "expiration":"2018-12-31T23:59:59" , "quantity": "100", "fill_or_kill": "0"}' -p inita@active
    ```
    Since there is no existing ask order to fill this order, this buy order will be added to buy order. You can check it via (Github PR #1091 need to be merged first):
    ```
    $ cleos get table exchange exchange bids
    {
    "rows": [{
        "buyer": {
            "name": "inita",
            "number": 1516073924
        },
        "at_price": "5000000000000000",
        "quantity": 100,
        "expiration": "2018-12-31T23:59:59"
        }
    ],
    "more": false
    }
    ```
    And checking account table, you will see that `inita` have new open order and some `eos` is deducted
    ```
    $ cleos get table exchange exchange account 
    {
    "rows": [{
        "owner": "inita",
        "eos_balance": 999900,
        "currency_balance": 0,
        "open_orders": 1
        },{
        "owner": "initb",
        "eos_balance": 0,
        "currency_balance": 1000000,
        "open_orders": 0
        }
    ],
    "more": false
    }
    ```

5. Now `initb` wants to make a sell order. He wants to sell 40 `currency` for `eos` with price 5 `currency` per `eos`.
    ```
    $ cleos push action exchange sell '{"seller":{ "name": "initb", "number": "1516073925"}, "at_price":"5000000000000000", "expiration":"2018-12-31T23:59:59", "quantity": "40", "fill_or_kill": "0"}' -p initb@active
    ```
    This will exactly match the previous buy order, and in addition place a new sell order for the surplus. (You will only see the following results if Github PR#1102 is merged)
    ```
    $ cleos get table exchange exchange bids
    {
        "rows": [],
        "more": false
    }
    $ cleos get table exchange exchange asks
    {
        "rows": [{
            "seller": {
                "name": "initb",
                "number": 1516073925
            },
            "at_price": "5000000000000000",
            "quantity": 20,
            "expiration": "2018-12-31T23:59:59"
            }
        ],
        "more": false
    }
    ```
    And you can see the account updated
    ```
    {
        "rows": [{
            "owner": "inita",
            "eos_balance": 999900,
            "currency_balance": 20,
            "open_orders": 0
            },{
            "owner": "initb",
            "eos_balance": 100,
            "currency_balance": 999960,
            "open_orders": 1
            }
        ],
        "more": false
        }
    ```


> NOTE: Currently, there is a problem with the matching when the matching will result in a PARTIALLY FILLED EXISTING ORDER. Github PR #1102 is open for this.

## Avoiding the matching problem until Github PR #1102 is merged
Don't let the matching results in a PARTIALLY FILLED EXISTING ORDER, or don't let the order to match at all
1. To avoid order from matching:
    - Place a buy order with quantity **SMALLER** than existing lowest ask.
    - Place a sell order with quantity **BIGGER** than existing highest bid.
2. To avoid the matching results in aPARTIALLY FILLED EXISTING ORDER:
    - Existing bid, new ask. New ask quantity >= (existing bid quantity/ existing bid price)
    - Existing ask, new bid. New bid quantity >= (existing ask quantity * existing asks price)

## Cancelling order
You can cancel order by giving the right `name` and order `number`, i.e.
```
$ cleos push action exchange cancelbuy '{ "name": "initb", "number": "1"}' -p initb@active
$ cleos push action exchange cancelsell '{ "name": "initb", "number": "1"}' -p initb@active
```

## Withdraw
To withdraw from exchange, you will need to send an `eos` transfer or `currency` transfer with both the signature of `exchange` and the recipient.
